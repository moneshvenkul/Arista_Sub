name: Update & Test Configs

on:
  schedule:
    - cron: '0 */1 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  update-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml
        
    - name: Install SpeedTest CLI
      run: |
        wget -O speedtest.tgz https://install.speedtest.net/app/cli/ookla-speedtest-1.2.0-linux-x86_64.tgz
        tar -xzf speedtest.tgz -C /usr/local/bin
        chmod +x /usr/local/bin/speedtest
        
    - name: Install Subconverter
      run: |
        wget -O subconverter.tar.gz https://github.com/tindy2013/subconverter/releases/download/v0.7.2/subconverter_linux64.tar.gz
        tar -zxvf subconverter.tar.gz -C ./
        chmod +x ./subconverter/subconverter
        
    - name: Run config updater and tester
      run: python update_configs.py
      
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: Commit and push changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "üîÑ Auto-update & test configs $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
        fi

  generate-readme:
    runs-on: ubuntu-latest
    needs: update-and-test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate README
      run: |
        cat > README.md << 'EOF'
        # üî• Arista Config Aggregator
        
        ![GitHub Workflow Status](https://img.shields.io/github/actions/workflow/status/YOUR_USERNAME/YOUR_REPO/update-test-configs.yml)
        ![GitHub last commit](https://img.shields.io/github/last-commit/YOUR_USERNAME/YOUR_REPO)
        ![Config Count](https://img.shields.io/badge/configs-1000+-blue)
        
        ## üìä Features
        
        - ‚úÖ Automatic config collection from multiple sources
        - ‚ö° Speed testing for best performance
        - üìÅ Categorized storage by protocol
        - üîÑ Auto-update every hour
        - üèÜ Best configs selection
        
        ## üìÅ Directory Structure
        
        ```
        ‚îú‚îÄ‚îÄ vmess/           # VMess configurations
        ‚îú‚îÄ‚îÄ vless/           # VLess configurations
        ‚îú‚îÄ‚îÄ trojan/          # Trojan configurations
        ‚îú‚îÄ‚îÄ ss/              # Shadowsocks configurations
        ‚îú‚îÄ‚îÄ hysteria2/       # Hysteria2 configurations
        ‚îú‚îÄ‚îÄ hysteria/        # Hysteria configurations
        ‚îú‚îÄ‚îÄ tuic/            # TUIC configurations
        ‚îú‚îÄ‚îÄ wireguard/       # WireGuard configurations
        ‚îú‚îÄ‚îÄ tested/          # Tested & optimized configs
        ‚îÇ   ‚îú‚îÄ‚îÄ best_configs.txt
        ‚îÇ   ‚îî‚îÄ‚îÄ best_configs.yml
        ‚îî‚îÄ‚îÄ all/             # All configurations
        ```
        
        ## üöÄ Quick Start
        
        1. **Raw Configs**: Use files in protocol folders
        2. **Tested Configs**: Use `tested/best_configs.yml` for Clash
        3. **All Configs**: Use `all/configs.txt` for complete list
        
        ## ‚ö° Best Tested Configs
        
        Latest tested configurations with low latency:
        
        ```yaml
        # Use in Clash: Configuration -> Import from URL
        https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/tested/best_configs.yml
        ```
        
        ## üîß Usage
        
        ### For Clash:
        ```bash
        # Import YAML config
        wget -O config.yaml https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/tested/best_configs.yml
        ```
        
        ### For V2Ray:
        ```bash
        # Use individual configs
        cat vmess/configs.txt | grep -A1 "fast"
        ```
        
        ## üìä Statistics
        
        | Protocol | Count | Tested |
        |----------|-------|--------|
        | VMess | ‚¨áÔ∏è Downloading... | ‚úÖ |
        | VLess | ‚¨áÔ∏è Downloading... | ‚úÖ |
        | Trojan | ‚¨áÔ∏è Downloading... | ‚úÖ |
        | SS | ‚¨áÔ∏è Downloading... | ‚úÖ |
        
        ## ‚è∞ Update Schedule
        
        - **Config Collection**: Every 1 hour
        - **Speed Testing**: Every collection cycle
        - **Best Configs**: Updated after each test
        
        ## ü§ù Contributing
        
        Feel free to submit PRs or open issues for new sources!
        
        ## üìù License
        
        MIT License - Free to use and modify
        
        ---
        
        *Last Updated: $(date)*
        EOF
        
    - name: Commit README
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add README.md
        git commit -m "üìù Update README" || echo "No changes to README"
        git push
